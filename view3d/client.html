<!doctype html>
<html>
  <head>
    <title>Socket.IO single test</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
    </style>
  </head>
  <body>
    <p id="">X <a href="#" id="x-plus">+</a>/<a href="#" id="x-minus">-</a></p>
    <p id="">Y <a href="#" id="y-plus">+</a>/<a href="#" id="y-minus">-</a></p>
    <p id="">Z <a href="#" id="z-plus">+</a>/<a href="#" id="z-minus">-</a></p>
    <p id="reset"><a href="#" id="reset">Reset</a></p>
    <p>Accelerometer: <input type="checkbox" id="accelerometer" value="accelerometer"></p>
    <p>
      <input type="text" id="x"><br />
      <input type="text" id="y"><br />
      <input type="text" id="z"><br />
    </p>
    <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
    <script src="http://code.jquery.com/jquery-1.11.1.js"></script>

    <script>

      function getParameterByName(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      var roomId = getParameterByName('roomID');
      var socket = io();

      if(roomId) {
        console.log("attempting to join room : " + roomId);

      } else {
        alert("Get a room dude!");
      }

      var movement = 500;
      var accoffset = 200;
      var roundoffset = 100;
      $( "#x-plus" ).click(function() {
        socket.to(roomId).emit('x-delta', movement);
      });
      $( "#x-minus" ).click(function() {
        socket.to(roomId).emit('x-delta', -movement);
      });
      $( "#y-plus" ).click(function() {
        socket.to(roomId).emit('y-delta', movement);
      });
      $( "#y-minus" ).click(function() {
        socket.to(roomId).emit('y-delta', -movement);
      });
      $( "#z-plus" ).click(function() {
        socket.to(roomId).emit('z-delta', movement);
      });
      $( "#z-minus" ).click(function() {
        socket.to(roomId).emit('z-delta', -movement);
      });
      $( "#reset" ).click(function() {
        socket.to(roomId).emit('reset', true);
      });
      $('#x').change(function (){
        socket.to(roomId).emit('x', $('#x').val());
      });
      $('#y').change(function (){
        socket.to(roomId).emit('y', $('#y').val());
      });
      $('#z').change(function (){
        socket.to(roomId).emit('z', $('#z').val());
      });

      socket.on('x', function(msg){
        $('#x').val(msg)
      });
      socket.on('y', function(msg){
        $('#y').val(msg)
      });
      socket.on('z', function(msg){
        $('#z').val(msg)
      });
      window.ondevicemotion = function(event) {
        if ($('input#accelerometer').is(':checked')) {
          socket.to(roomId).emit('x', Math.round(event.accelerationIncludingGravity.x * accoffset / roundoffset) * roundoffset);
          socket.to(roomId).emit('y', Math.round(event.accelerationIncludingGravity.y * accoffset / roundoffset) * roundoffset);
          socket.to(roomId).emit('z', Math.round(event.accelerationIncludingGravity.z * accoffset / roundoffset) * roundoffset);
        }
      }
    </script>
  </body>
</html>
